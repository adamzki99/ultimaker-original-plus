#-------------------------------------------------------------------------------#
#-------------------------------- Custom Macros --------------------------------#
#-------------------------------------------------------------------------------#
#-------------------------------------------------------------------------------#

[gcode_macro CENTER_PRINT_HEAD]
gcode:
    G28 ;home all axis
    G1 Z5
    G1 X102.5 Y102.5 F6000
    M400

[gcode_macro LEVEL_BED]
    # https://www.klipper3d.org/Manual_Level.html
gcode:
    G28 ;home all axis
    BED_SCREWS_ADJUST ;start leveling the bed

[gcode_macro REMOVE_MATERIAL]
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(210)|float %}
    
    G90 ;absolute coordinates
    G28 X0 Y0 ;home gantry

    G1 X102.5 Y10.0 ;move the nozzle to the front
    
    M109 S{EXTRUDER_TEMP} ;wait for nozzle to reach temp

    G92 E0 ;reset extruder
    G1 E-5 F100 ;retract 5 mm slowly
    G1 E-800 F1500 ;retract 800 mm

    M400 ;wait for previous moves

[gcode_macro INSERT_MATERIAL]
gcode:
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|float %}
    G90 ;use absolute coordinates
    G92 E0 ;reset extruder

    M109 S{EXTRUDER_TEMP} ;wait for nozzle to reach temp
    
    G1 E650 F1500 ;extrude 650 mm, fast, to the hotend
    G1 E50 F100 ;extrude 100 mm slowly
    
    M400 ;wait for previous moves
    G1 E-10 F1500 ;perform a small, fast, retract to limit ooze
    G92 E0 ;reset extruder

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

    SKEW_PROFILE LOAD=calilantern_skew_profile
   
    G21 ;metric values
    G90 ;absolute positioning
    M82 ;set extruder to absolute mode
    M107 ;start with the fan off
    G28 X0 Y0 ;move X/Y to min endstops
    G28 Z0 ;move Z to min endstops
    #G1 X102.5 Y2.5 Z15.0 F9000 ;move the platform down 15mm and bring printhead forward

    M400 ;wait for previous moves
    M140 S{BED_TEMP} ;start bed heating
    M190 S{BED_TEMP} ;wait unitl bed has reached its target
    M104 S{EXTRUDER_TEMP} ;start nozzle heating

    M400 ;wait for previous moves
    G92 E0 ;zero the extruded length
    G1 X102.5 Y202.0 Z0.3 F5000.0 ;move to start position
    M109 S{EXTRUDER_TEMP} ;wait for nozzle to reach temp before proceeding
    G92 E0 ;zero the extruded length again
    G1 X202.0 Y202.0 Z0.3 F1500.0 E5 ;draw the first line
    G1 X202.0 Y2.5 Z0.3 F1500.0 E15 ;draw the second line
    G92 E0 ;zero the extruded length
    G1 Z2.0 F3000 ;move z up little to prevent scratching of Heat Bed
    G1 X202.0 Y105.0 Z0.3 F5000.0 ;move over to prevent blob squish
    
    M400 ;wait for previous moves

[gcode_macro END_PRINT]
gcode:
    M400 ;wait for previous moves
    M104 S0 ;extruder heater off
    M140 S0 ;heated bed heater off

    G91 ;relative positioning
    G1 E-1 F300  ;retract the filament a bit before lifting the nozzle, to release some of the pressure
    G1 Z+0.5 E-5 X-20 Y-20 F9000 ;move Z up a bit and retract filament even more
    G90 ;absolute positioning
    G1 X202.5 Y202.5 Z200 ;move the print-head out of the way
    
    M84 ;steppers off

    SET_SKEW CLEAR=1
    
[gcode_macro CANCEL_PRINT]
gcode:
    M400 ;wait for previous moves
    G28 X0.0 Y0.0 ;home gantry so the print-head is out of the way

    M400 ;wait for previous moves
    G91 ;relative positioning
    G1 E-1 F9000 ;retract the filament a bit before lifting the nozzle to release some of the pressure
    G1 E-5 F300 ;retract the filament even more
    M106 S76 ;set fan speed to 30% to prevent heat soaking

    M400 ;wait for previous moves
    M84 ;steppers off

#-------------------------------------------------------------------------------#
#------------------------------- Klipper Defined -------------------------------#
#-- https://github.com/Klipper3d/klipper/blob/master/config/sample-macros.cfg --#
#-------------------------------------------------------------------------------#

######################################################################
# Override M117 command with rawparams
######################################################################

# The macro below will override the default M117 command to echo the message.
#
# It uses the rawparams pseudo-variable that contains the full unparsed
# parameters that was passed to the M117 command.
#
# As this can include comments, we are trimming the text when a `;` or `#` is
# found, and escaping any existing `"`

[gcode_macro M117]
rename_existing: M117.1
gcode:
  {% if rawparams %}
    {% set escaped_msg = rawparams.split(';', 1)[0].split('\x23', 1)[0]|replace('"', '\\"') %}
    SET_DISPLAY_TEXT MSG="{escaped_msg}"
    RESPOND TYPE=command MSG="{escaped_msg}"
  {% else %}
    SET_DISPLAY_TEXT
  {% endif %}

# SDCard 'looping' (aka Marlin M808 commands) support
#
# Support SDCard looping
[sdcard_loop]

# 'Marlin' style M808 compatibility macro for SDCard looping
[gcode_macro M808]
gcode:
    {% if params.K is not defined and params.L is defined %}SDCARD_LOOP_BEGIN COUNT={params.L|int}{% endif %}
    {% if params.K is not defined and params.L is not defined %}SDCARD_LOOP_END{% endif %}
    {% if params.K is defined and params.L is not defined %}SDCARD_LOOP_DESIST{% endif %}

# Cancel object (aka Marlin/RRF M486 commands) support
#
# Enable object exclusion
[exclude_object]

[gcode_macro M486]
gcode:
  # Parameters known to M486 are as follows:
  #   [C<flag>] Cancel the current object
  #   [P<index>] Cancel the object with the given index
  #   [S<index>] Set the index of the current object.
  #       If the object with the given index has been canceled, this will cause
  #       the firmware to skip to the next object. The value -1 is used to
  #       indicate something that isn’t an object and shouldn’t be skipped.
  #   [T<count>] Reset the state and set the number of objects
  #   [U<index>] Un-cancel the object with the given index. This command will be
  #       ignored if the object has already been skipped

  {% if 'exclude_object' not in printer %}
    {action_raise_error("[exclude_object] is not enabled")}
  {% endif %}

  {% if 'T' in params %}
    EXCLUDE_OBJECT RESET=1

    {% for i in range(params.T | int) %}
      EXCLUDE_OBJECT_DEFINE NAME={i}
    {% endfor %}
  {% endif %}

  {% if 'C' in params %}
    EXCLUDE_OBJECT CURRENT=1
  {% endif %}

  {% if 'P' in params %}
    EXCLUDE_OBJECT NAME={params.P}
  {% endif %}

  {% if 'S' in params %}
    {% if params.S == '-1' %}
      {% if printer.exclude_object.current_object %}
        EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
      {% endif %}
    {% else %}
      EXCLUDE_OBJECT_START NAME={params.S}
    {% endif %}
  {% endif %}

  {% if 'U' in params %}
    EXCLUDE_OBJECT RESET=1 NAME={params.U}
  {% endif %}
